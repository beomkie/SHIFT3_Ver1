<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/user/layout/mypage_layout}" lang="ko">

<div layout:fragment="content" class="content">

	<div class="card">
		<div class="card-header">
			íšŒì›ì •ë³´ ìˆ˜ì •
		</div>
		<div class="welcome"></div>
		<script>
            // get parameter 'firstLogin'
            var firstLogin = new URLSearchParams(window.location.search).get('firstLogin');
            if (firstLogin) {
                $('.welcome').html(`
					<div class="alert alert-success mb-0" role="alert">í™˜ì˜í•©ë‹ˆë‹¤ ğŸ‰ğŸ‰ğŸ‰</div>
					<div class="alert alert-warning" role="alert">ì›í• í•œ ì„œë¹„ìŠ¤ ì´ìš©ì„ ìœ„í•´ íšŒì›ì •ë³´ë¥¼ ì…ë ¥ í›„ ìˆ˜ì •ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
					`);
            }
		</script>
		<div class="card-body">
			<div class="card-text">

				<div class="form-floating mb-2" id="nameDiv">
					<input class="form-control" type="text" id="name" name="name"
					       placeholder="ì´ë¦„" th:value="${account.name}">
					<label for="name">ì´ë¦„</label>
				</div>

				<div class="form-floating mb-3" id="phoneNumberDiv">
					<input class="form-control" type="text" id="phoneNumber" name="phoneNumber"
					       placeholder="í•¸ë“œí° ë²ˆí˜¸"
					       oninput='autoHyphen(this);'
					       maxlength="13"
					       th:value="${account.phoneNumber}">
					<label for="phoneNumber">í•¸ë“œí° ë²ˆí˜¸</label>
				</div>


				<th:block th:if="${account.provider == '' || account.provider == null}">
					<!--					<div class="form-group mb-3" id="passwordDiv">-->
					<!--						<input class="form-control" type="password" id="nowPassword" name="nowPassword"-->
					<!--						       placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸" required="">-->
					<!--					</div>-->

					<div class="row mb-3" id="passwordDiv">
						<div class="col-6">
							<div class="form-floating">
								<input class="form-control" type="password" id="password" name="password"
								       placeholder="ë°”ê¿€ ë¹„ë°€ë²ˆí˜¸">
								<label for="password">ë³€ê²½í•  ë¹„ë°€ë²ˆí˜¸</label>
							</div>
						</div>

						<div class="col-6">
							<div class="form-floating">
								<input class="form-control" type="password" id="passwordChk" name="passwordChk"
								       placeholder="ë°”ê¿€ ë¹„ë°€ë²ˆí˜¸ í™•ì¸">
								<label for="passwordChk">ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥</label>
							</div>
						</div>
						<span class="text-muted ms-2">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì‹œì—ë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”.</span>
					</div>
				</th:block>

				<th:block th:unless="${account.provider == '' || account.provider == null}">
					<div class="form-group mb-3">
						<input class="form-control" type="password"
						       value="password1234" id="nochange"
						       placeholder="ë¹„ë°€ë²ˆí˜¸" readonly>
						<label for="nochange">SNS ê³„ì • ë¡œê·¸ì¸ ìœ ì €ëŠ” ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.</label>
					</div>
				</th:block>

				<div class="form-check mb-4">
					<input id="informationToThirdParties" type="checkbox"
					       th:checked="${account.informationToThirdParties}"/>
					<label class="form-check-label" for="informationToThirdParties">
						ê°œì¸ì •ë³´ 3ìì œê³µ ë™ì˜
					</label>
				</div>


				<div class="login_wrap mt-3 mb-3">
					<div class="small_padding bg-white">
						<div class="heading_s1">
							<h5>ê´€ì‹¬ì‚¬ ì„¤ì •</h5>
						</div>

						<div class="form-group" id="interestDiv">
							<input
									name='input'
									id="interest"
									class="form-control"
									placeholder='ê´€ì‹¬ì‚¬ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.'
									th:value="${account.interest}">
						</div>

						<script>
                            let inputElm = document.querySelector('input[id="interest"]');
                            // initialize Tagify on the above input node reference
                            loadingTag(inputElm);
						</script>
					</div>
				</div>


				<div class="form-group mb-3">
					<button type="button" class="btn btn-fill-out btn-block" name="signup"
					        onclick="editMyAccount()">íšŒì›ì •ë³´ ìˆ˜ì •
					</button>

					<script>
                        function getData() {
                            return {
                                "name": $("#name").val(),
                                "phoneNumber": $("#phoneNumber").val(),
                                "nowPassword": $("#nowPassword").val(),
                                "password": $("#password").val(),
                                "passwordChk": $("#passwordChk").val(),
                                "interest": $("#interest").val(),
                                "informationToThirdParties": $("#informationToThirdParties").is(":checked")
                            }
                        }

                        window.editMyAccount = function () {
                            let data = getData();
                            let pass = true;

                            $(".card span.text-warning").remove();

                            if (data.name === "" || data.name.match(koreanRegex) == null) {
                                $("#nameDiv").append(
                                    `<span class="text-warning">ì´ë¦„ì„ ì œëŒ€ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”</span>`
                                );
                                pass = false;
                            }

                            if (document.getElementById("nochange") == null) {
                                if (data.password !== "") {
                                    if (data.password !== data.passwordChk) {
                                        $("#passwordDiv").append(
                                            `<span class="text-warning">ë°”ê¿€ ë¹„ë°€ë²ˆí˜¸ê°€ ì„œë¡œ ë‹¤ë¦…ë‹ˆë‹¤</span>`
                                        )
                                        pass = false;
                                    } else if (data.password.match(passwordRegex) == null) {
                                        $("#passwordDiv").append(
                                            `<span class="text-warning">ë¹„ë°€ë²ˆí˜¸ëŠ” ${passwordRegexRule}ë¥¼ ë§Œì¡±í•´ì•¼ í•©ë‹ˆë‹¤</span>`
                                        )
                                        pass = false;
                                    }
                                } else {
                                    data.password = null;
                                }
                            } else {
                                data.password = null;
                            }

                            if (data.interest === "") {
                                $("#interestDiv").append(
                                    `<span class="text-warning">ê´€ì‹¬ì‚¬ë¥¼ í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”</span>`
                                )
                                pass = false;
                            }

                            if (data.phoneNumber.length !== 13) {
                                $("#phoneNumberDiv").append(
                                    `<span class="text-warning">í•¸ë“œí° ë²ˆí˜¸ë¥¼ ì œëŒ€ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”</span>`
                                )
                                pass = false;
                            }

                            if (pass === false)
                                return

                            $.ajax({
                                url: '/account/update.do',
                                type: 'POST',
                                data: data,
                                success: function (data) {
                                    alert('ì •ë³´ë¥¼ ë³€ê²½í•˜ì˜€ìŠµë‹ˆë‹¤.');
                                    window.location.href = "/mypage";
                                },
                                error: function (data) {
                                    alert(data.responseText);
                                }
                            })

                        }
					</script>
				</div>
			</div>
		</div>
	</div>
</div>
</html>